<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Strategy Setup | moomoo API Doc v9.6</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="moomoo API Doc">
    <link rel="preload" href="/moomoo-api-doc/assets/css/0.styles.ea0b1d81.css" as="style"><link rel="preload" href="/moomoo-api-doc/assets/js/app.76d125c0.js" as="script"><link rel="preload" href="/moomoo-api-doc/assets/js/2.e1858e4a.js" as="script"><link rel="preload" href="/moomoo-api-doc/assets/js/30.aee38619.js" as="script"><link rel="preload" href="/moomoo-api-doc/assets/js/28.3fe3716c.js" as="script"><link rel="preload" href="/moomoo-api-doc/assets/js/35.424be492.js" as="script"><link rel="prefetch" href="/moomoo-api-doc/assets/js/10.94bcbf16.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/100.5aad709f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/101.6315f7fb.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/102.6cece76d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/103.40195fc5.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/104.e0830381.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/105.936eb4d9.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/106.ed3aee2b.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/107.7748df13.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/108.39b67a60.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/109.4b1236e2.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/11.2fbf442f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/110.bc264581.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/111.a9652fa1.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/112.038c2fcd.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/113.587f4a42.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/114.9203188f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/115.0d36e730.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/116.0f4b866f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/117.76221359.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/118.caa7bc9a.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/119.ba336510.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/12.c4851259.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/120.3683de14.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/121.ea95d7cb.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/122.618c3ed6.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/123.055b7010.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/124.c045cd63.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/125.d42b0714.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/126.b2f6e933.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/127.e9d110f8.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/128.a11f8202.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/129.6626eb94.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/13.4f3b3d7e.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/130.6539fcba.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/131.75bdf579.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/132.9d24d7e7.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/133.d9e1803b.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/134.a475efd5.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/135.cc33709b.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/136.21873923.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/137.69826660.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/138.31047450.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/139.ce995941.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/14.13b59c71.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/140.e70bdec0.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/141.d9d53a87.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/142.a04d0bea.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/143.a672978f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/144.818a84ae.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/145.e46cc3df.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/146.a29ec4b9.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/147.5cfe641e.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/148.358ecaa0.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/149.3935be2f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/15.3d02da17.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/150.40c46b61.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/151.3456807d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/152.308a6ffd.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/153.d95721a5.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/154.c6b90cda.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/155.68c534de.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/156.fa6d7af3.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/157.a33831dd.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/158.56280019.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/159.9b880f55.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/16.33d80555.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/160.f4aa9622.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/161.727a3a78.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/162.941951ea.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/163.8b7da111.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/164.dfd53e0d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/165.0c0855cd.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/166.21bd9238.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/167.e4ae9cf3.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/168.3f4281c0.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/169.f37d7335.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/17.6ac2d3ef.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/170.4376c120.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/171.948e10e3.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/18.7deab3c8.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/19.6e70cac3.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/20.c1df6286.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/21.5647999f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/22.a50b564c.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/23.7870807e.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/24.9af08641.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/25.f509878d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/26.b1244706.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/27.082f3f2b.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/29.f69366ed.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/3.f9c39755.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/31.7ab0c7db.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/32.d4a3260b.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/33.74565b1d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/34.29135595.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/36.3857d105.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/37.7d889315.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/38.637a73c2.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/39.aa973d8f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/4.04d2c45d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/40.480f6bad.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/41.62d11f5f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/42.6861ed24.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/43.b8eb0308.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/44.e0fc8394.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/45.12015c46.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/46.acc698c7.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/47.997f18b2.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/48.c0a3ed4b.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/49.605a98fa.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/5.8c452a45.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/50.ab8e902f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/51.93a43c80.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/52.d7c28131.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/53.bc4fcbfa.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/54.f2134ef8.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/55.0fb8c79f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/56.d6f1d66e.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/57.e3b3ea62.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/58.a3b791f0.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/59.15613da4.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/6.9a2ded1c.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/60.60f97ce5.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/61.adf5183d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/62.10e9e40e.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/63.f3768483.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/64.5e7093fb.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/65.437af457.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/66.fc1b6993.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/67.14953f01.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/68.5b8d5ad6.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/69.7f2d1c8b.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/7.f1cb5afb.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/70.2cfa12e6.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/71.0acce1e8.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/72.74bec554.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/73.00d57d06.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/74.bbe2f552.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/75.654e7361.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/76.e7abbb6c.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/77.9c2ecdf1.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/78.3eaa2d23.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/79.cc7f1ac2.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/8.e457aac2.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/80.148805ce.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/81.40dc2530.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/82.bbe1f83f.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/83.d1ecfd2c.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/84.5013f0ea.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/85.ed102602.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/86.f2975c25.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/87.7d6540bd.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/88.6f722f70.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/89.8fed8c82.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/9.c9d4402a.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/90.a15edebc.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/91.1f997c5d.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/92.dd51fa69.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/93.042545f6.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/94.71d9cc14.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/95.fb45f9d3.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/96.0f81a014.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/97.09768abd.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/98.cc14b450.js"><link rel="prefetch" href="/moomoo-api-doc/assets/js/99.6d2cbe79.js">
    <link rel="stylesheet" href="/moomoo-api-doc/assets/css/0.styles.ea0b1d81.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/moomoo-api-doc/en/" class="home-link router-link-active"><img src="/moomoo-api-doc/img/logo.png" alt="moomoo API Doc v9.6" class="logo"> <span class="site-name can-hide">moomoo API Doc v9.6</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="ftcode-links can-hide"><div class="ftcode-item"><div class="ftcode-dropdown-wrapper"><button type="button" aria-label="Programming Language" class="ftcode-dropdown-title"><span class="title">Programming Language</span> <span class="arrow right"></span></button> <ul class="ftcode-dropdown" style="display:none;"><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link active"><span class="arrow active"></span> <span class="title active">Python</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">C#</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">Java</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">C++</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">JavaScript</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">proto</span></span></li></ul></div></div></nav> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="简体中文" class="dropdown-title"><span class="title">简体中文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/moomoo-api-doc/quick/strategy-sample.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/moomoo-api-doc/en/quick/strategy-sample.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="ftcode-links"><div class="ftcode-item"><div class="ftcode-dropdown-wrapper"><button type="button" aria-label="Programming Language" class="ftcode-dropdown-title"><span class="title">Programming Language</span> <span class="arrow right"></span></button> <ul class="ftcode-dropdown" style="display:none;"><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link active"><span class="arrow active"></span> <span class="title active">Python</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">C#</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">Java</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">C++</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">JavaScript</span></span></li><li class="ftcode-dropdown-item"><!----> <span class="ftcode-link"><span class="arrow"></span> <span class="title">proto</span></span></li></ul></div></div></nav> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="简体中文" class="dropdown-title"><span class="title">简体中文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/moomoo-api-doc/quick/strategy-sample.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/moomoo-api-doc/en/quick/strategy-sample.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading openData"><span>Quick Start</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/moomoo-api-doc/en/quick/opend-base.html" class="sidebar-link">Visualization OpenD</a></li><li><a href="/moomoo-api-doc/en/quick/env.html" class="sidebar-link">Environment Setup</a></li><li><a href="/moomoo-api-doc/en/quick/demo.html" class="sidebar-link">Program Samples</a></li><li><a href="/moomoo-api-doc/en/quick/strategy-sample.html" aria-current="page" class="active sidebar-link">Strategy Setup</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OpenD</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Quote API</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Trade API</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Basic API</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Q&amp;A</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="6712"><a href="#6712" class="header-anchor">#</a> Strategy Setup</h1> <div class="ft-doc-switcher"><div class="tab-content" style="display:none;"><div class="ft-switcher"><div class="tab-header" style="display:none;"><ul><li class="active"> Python
            </li><li> Proto
            </li><li> C#
            </li><li> Java
            </li><li> C++
            </li><li> JavaScript
            </li></ul></div> <div class="tab-content" style="display:;"><div class="custom-block tip"><p class="custom-block-title">Tips</p> <ul><li>The content of this trading strategy is not an investment advice. It is for learning purposes only.</li></ul></div> <h2 id="7486"><a href="#7486" class="header-anchor">#</a> Strategy Introduction</h2> <p>Contruct a Double Moving Averaging Strategy.</p> <p>That is, using the 1 minute candlestick of an underlying stock, to calculate two moving averages of different periods, MA1 and MA3. The values of MA1 and MA3 are tracked to determine the timing of buying and selling.</p> <p>When MA1 &gt;= MA3, the underlying stock is judged to be strong and the market is considered to be a bull market, which shows a long signal.<br>
When MA1 &lt; MA3, the underlying stock is judged to be weak and the market is considered to be a bear market, which shows a short signal.</p> <h2 id="8601"><a href="#8601" class="header-anchor">#</a> Flow Chart</h2> <p><img src="/moomoo-api-doc/assets/img/strategy-flow-chart.9e0fbe4d.png" alt="strategy-flow-chart"></p> <h2 id="6526"><a href="#6526" class="header-anchor">#</a> Code Sample</h2> <ul><li><strong>Example</strong></li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> futu <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment">############################ Global Variables ############################</span>
FUTU_OPEND_ADDRESS <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span>  <span class="token comment"># OpenD listening address</span>
FUTU_OPEND_PORT <span class="token operator">=</span> <span class="token number">11111</span>  <span class="token comment"># OpenD listening port</span>

TRADING_ENVIRONMENT <span class="token operator">=</span> TrdEnv<span class="token punctuation">.</span>SIMULATE  <span class="token comment"># Trading environment: REAL / SIMULATE</span>
TRADING_MARKET <span class="token operator">=</span> TrdMarket<span class="token punctuation">.</span>HK  <span class="token comment"># Transaction market authority, used to filter accounts</span>
TRADING_PWD <span class="token operator">=</span> <span class="token string">'123456'</span>  <span class="token comment"># Trading password, used to unlock trading for real trading environment</span>
TRADING_PERIOD <span class="token operator">=</span> KLType<span class="token punctuation">.</span>K_1M  <span class="token comment"># Underlying trading time period</span>
TRADING_SECURITY <span class="token operator">=</span> <span class="token string">'HK.00700'</span>  <span class="token comment"># Underlying trading security code</span>
FAST_MOVING_AVERAGE <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># Parameter for fast moving average</span>
SLOW_MOVING_AVERAGE <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># Parameter for slow moving average</span>

quote_context <span class="token operator">=</span> OpenQuoteContext<span class="token punctuation">(</span>host<span class="token operator">=</span>FUTU_OPEND_ADDRESS<span class="token punctuation">,</span> port<span class="token operator">=</span>FUTU_OPEND_PORT<span class="token punctuation">)</span>  <span class="token comment"># Quotation context</span>
trade_context <span class="token operator">=</span> OpenSecTradeContext<span class="token punctuation">(</span>filter_trdmarket<span class="token operator">=</span>TRADING_MARKET<span class="token punctuation">,</span> host<span class="token operator">=</span>FUTU_OPEND_ADDRESS<span class="token punctuation">,</span> port<span class="token operator">=</span>FUTU_OPEND_PORT<span class="token punctuation">,</span> security_firm<span class="token operator">=</span>SecurityFirm<span class="token punctuation">.</span>FUTUSECURITIES<span class="token punctuation">)</span>  <span class="token comment"># Trading context. It must be consistent with the underlying varieties.</span>


<span class="token comment"># Unlock trade</span>
<span class="token keyword">def</span> <span class="token function">unlock_trade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> TRADING_ENVIRONMENT <span class="token operator">==</span> TrdEnv<span class="token punctuation">.</span>REAL<span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>unlock_trade<span class="token punctuation">(</span>TRADING_PWD<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Unlock trade failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Unlock Trade success!'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment"># Check if it is regular trading time for underlying security</span>
<span class="token keyword">def</span> <span class="token function">is_normal_trading_time</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_market_state<span class="token punctuation">(</span><span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get market state failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    market_state <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'market_state'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token triple-quoted-string string">'''
    MarketState.MORNING            HK and A-share morning
    MarketState.AFTERNOON          HK and A-share afternoon, US opening hours
    MarketState.FUTURE_DAY_OPEN    HK, SG, JP futures day market open
    MarketState.FUTURE_OPEN        US futures open
    MarketState.FUTURE_BREAK_OVER  Trading hours of U.S. futures after break
    MarketState.NIGHT_OPEN         HK, SG, JP futures night market open
    '''</span>
    <span class="token keyword">if</span> market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>MORNING <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>AFTERNOON <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>FUTURE_DAY_OPEN  <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>FUTURE_OPEN  <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>FUTURE_BREAK_OVER  <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>NIGHT_OPEN<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'It is not regular trading hours.'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token comment"># Get positions</span>
<span class="token keyword">def</span> <span class="token function">get_holding_position</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    holding_position <span class="token operator">=</span> <span class="token number">0</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>position_list_query<span class="token punctuation">(</span>code<span class="token operator">=</span>code<span class="token punctuation">,</span> trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get holding position failed：'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> qty <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'qty'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            holding_position <span class="token operator">+=</span> qty
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Holidng Position Status] The holidng position quantity of {} is：{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> holding_position<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> holding_position



<span class="token comment"># Query for candlesticks, calculate moving average value and judge bull or bear</span>
<span class="token keyword">def</span> <span class="token function">calculate_bull_bear</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> fast_param<span class="token punctuation">,</span> slow_param<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fast_param <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">or</span> slow_param <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">if</span> fast_param <span class="token operator">&gt;</span> slow_param<span class="token punctuation">:</span>
        <span class="token keyword">return</span> calculate_bull_bear<span class="token punctuation">(</span>code<span class="token punctuation">,</span> slow_param<span class="token punctuation">,</span> fast_param<span class="token punctuation">)</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_cur_kline<span class="token punctuation">(</span>code<span class="token operator">=</span>code<span class="token punctuation">,</span> num<span class="token operator">=</span>slow_param <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> ktype<span class="token operator">=</span>TRADING_PERIOD<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get candlestick value failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    candlestick_list <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    fast_value <span class="token operator">=</span> <span class="token boolean">None</span>
    slow_value <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">)</span> <span class="token operator">&gt;</span> fast_param<span class="token punctuation">:</span>
        fast_value <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span> fast_param <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> fast_param
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">)</span> <span class="token operator">&gt;</span> slow_param<span class="token punctuation">:</span>
        slow_value <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span> slow_param <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> slow_param
    <span class="token keyword">if</span> fast_value <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> slow_value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token keyword">if</span> fast_value <span class="token operator">&gt;=</span> slow_value <span class="token keyword">else</span> <span class="token operator">-</span><span class="token number">1</span>


<span class="token comment"># Get ask1 and bid1 from order book</span>
<span class="token keyword">def</span> <span class="token function">get_ask_and_bid</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_order_book<span class="token punctuation">(</span>code<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get order book failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token string">'Ask'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Bid'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>


<span class="token comment"># Open long positions</span>
<span class="token keyword">def</span> <span class="token function">open_position</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Get order book data</span>
    ask<span class="token punctuation">,</span> bid <span class="token operator">=</span> get_ask_and_bid<span class="token punctuation">(</span>code<span class="token punctuation">)</span>

    <span class="token comment"># Get quantity</span>
    open_quantity <span class="token operator">=</span> calculate_quantity<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Check whether buying power is enough</span>
    <span class="token keyword">if</span> is_valid_quantity<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> open_quantity<span class="token punctuation">,</span> ask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Place order</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>place_order<span class="token punctuation">(</span>price<span class="token operator">=</span>ask<span class="token punctuation">,</span> qty<span class="token operator">=</span>open_quantity<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">,</span> trd_side<span class="token operator">=</span>TrdSide<span class="token punctuation">.</span>BUY<span class="token punctuation">,</span>
                                              order_type<span class="token operator">=</span>OrderType<span class="token punctuation">.</span>NORMAL<span class="token punctuation">,</span> trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">,</span>
                                              remark<span class="token operator">=</span><span class="token string">'moving_average_strategy'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Open position failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Maximum quantity that can be bought less than transaction quantity.'</span><span class="token punctuation">)</span>


<span class="token comment"># Close position</span>
<span class="token keyword">def</span> <span class="token function">close_position</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> quantity<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Get order book data</span>
    ask<span class="token punctuation">,</span> bid <span class="token operator">=</span> get_ask_and_bid<span class="token punctuation">(</span>code<span class="token punctuation">)</span>

    <span class="token comment"># Check quantity</span>
    <span class="token keyword">if</span> quantity <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Invalid order quantity.'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token comment"># Close position</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>place_order<span class="token punctuation">(</span>price<span class="token operator">=</span>bid<span class="token punctuation">,</span> qty<span class="token operator">=</span>quantity<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">,</span> trd_side<span class="token operator">=</span>TrdSide<span class="token punctuation">.</span>SELL<span class="token punctuation">,</span>
                   order_type<span class="token operator">=</span>OrderType<span class="token punctuation">.</span>NORMAL<span class="token punctuation">,</span> trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">,</span> remark<span class="token operator">=</span><span class="token string">'moving_average_strategy'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Close position failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment"># Calculate order quantity</span>
<span class="token keyword">def</span> <span class="token function">calculate_quantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    price_quantity <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># Use minimum lot size</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_market_snapshot<span class="token punctuation">(</span><span class="token punctuation">[</span>TRADING_SECURITY<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get market snapshot failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> price_quantity
    price_quantity <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'lot_size'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> price_quantity


<span class="token comment"># Check the buying power is enough for the quantity</span>
<span class="token keyword">def</span> <span class="token function">is_valid_quantity</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> quantity<span class="token punctuation">,</span> price<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>acctradinginfo_query<span class="token punctuation">(</span>order_type<span class="token operator">=</span>OrderType<span class="token punctuation">.</span>NORMAL<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">,</span> price<span class="token operator">=</span>price<span class="token punctuation">,</span>
                                                   trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get max long/short quantity failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    max_can_buy <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'max_cash_buy'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    max_can_sell <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'max_sell_short'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> quantity <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> quantity <span class="token operator">&lt;</span> max_can_buy
    <span class="token keyword">elif</span> quantity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_can_sell
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token comment"># Show order status</span>
<span class="token keyword">def</span> <span class="token function">show_order_status</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    order_status <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'order_status'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    order_info<span class="token punctuation">[</span><span class="token string">'Code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info<span class="token punctuation">[</span><span class="token string">'Price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info<span class="token punctuation">[</span><span class="token string">'TradeSide'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'trd_side'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info<span class="token punctuation">[</span><span class="token string">'Quantity'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'qty'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[OrderStatus]'</span><span class="token punctuation">,</span> order_status<span class="token punctuation">,</span> order_info<span class="token punctuation">)</span>


<span class="token comment">############################ Fill in the functions below to finish your trading strategy ############################</span>
<span class="token comment"># Strategy initialization. Run once when the strategy starts</span>
<span class="token keyword">def</span> <span class="token function">on_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># unlock trade (no need to unlock for paper trading)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> unlock_trade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'************  Strategy Starts ***********'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment"># Run once for each tick. You can write the main logic of the strategy here</span>
<span class="token keyword">def</span> <span class="token function">on_tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token comment"># Run once for each new candlestick. You can write the main logic of the strategy here</span>
<span class="token keyword">def</span> <span class="token function">on_bar_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Print seperate line</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*****************************************'</span><span class="token punctuation">)</span>

    <span class="token comment"># Only trade during regular trading hours</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_normal_trading_time<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    <span class="token comment"># Query for candlesticks, and calculate moving average value</span>
    bull_or_bear <span class="token operator">=</span> calculate_bull_bear<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> FAST_MOVING_AVERAGE<span class="token punctuation">,</span> SLOW_MOVING_AVERAGE<span class="token punctuation">)</span>

    <span class="token comment"># Get positions</span>
    holding_position <span class="token operator">=</span> get_holding_position<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">)</span>

    <span class="token comment"># Trading signals</span>
    <span class="token keyword">if</span> holding_position <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> bull_or_bear <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Long signal. Open long positions.'</span><span class="token punctuation">)</span>
            open_position<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Short signal. Do not open short positions.'</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> holding_position <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> bull_or_bear <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Short signal. Close positions.'</span><span class="token punctuation">)</span>
            close_position<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> holding_position<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Long signal. Do not add positions.'</span><span class="token punctuation">)</span>


<span class="token comment"># Run once when an order is filled</span>
<span class="token keyword">def</span> <span class="token function">on_fill</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token comment"># Run once when the status of an order changes</span>
<span class="token keyword">def</span> <span class="token function">on_order_status</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> TRADING_SECURITY<span class="token punctuation">:</span>
        show_order_status<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token comment">############################### Framework code, which can be ignored ###############################</span>
<span class="token keyword">class</span> <span class="token class-name">OnTickClass</span><span class="token punctuation">(</span>TickerHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        on_tick<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">OnBarClass</span><span class="token punctuation">(</span>CurKlineHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    last_time <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret_code<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>OnBarClass<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>on_recv_rsp<span class="token punctuation">(</span>rsp_pb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret_code <span class="token operator">==</span> RET_OK<span class="token punctuation">:</span>
            cur_time <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'time_key'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> cur_time <span class="token operator">!=</span> self<span class="token punctuation">.</span>last_time <span class="token keyword">and</span> data<span class="token punctuation">[</span><span class="token string">'k_type'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> TRADING_PERIOD<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>last_time <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    on_bar_open<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>last_time <span class="token operator">=</span> cur_time


<span class="token keyword">class</span> <span class="token class-name">OnOrderClass</span><span class="token punctuation">(</span>TradeOrderHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>OnOrderClass<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>on_recv_rsp<span class="token punctuation">(</span>rsp_pb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">==</span> RET_OK<span class="token punctuation">:</span>
            on_order_status<span class="token punctuation">(</span> data<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">OnFillClass</span><span class="token punctuation">(</span>TradeDealHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>OnFillClass<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>on_recv_rsp<span class="token punctuation">(</span>rsp_pb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">==</span> RET_OK<span class="token punctuation">:</span>
            on_fill<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token comment"># Main function</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># Strategy initialization</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> on_init<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Strategy initialization failed, exit script!'</span><span class="token punctuation">)</span>
        quote_context<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        trade_context<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Set up callback functions</span>
        quote_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnTickClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        quote_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnBarClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trade_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnOrderClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trade_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnFillClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Subscribe tick-by-tick, candlestick and order book of the underlying trading security</span>
        quote_context<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span>code_list<span class="token operator">=</span><span class="token punctuation">[</span>TRADING_SECURITY<span class="token punctuation">]</span><span class="token punctuation">,</span> subtype_list<span class="token operator">=</span><span class="token punctuation">[</span>SubType<span class="token punctuation">.</span>TICKER<span class="token punctuation">,</span> SubType<span class="token punctuation">.</span>ORDER_BOOK<span class="token punctuation">,</span> TRADING_PERIOD<span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br></div></div><ul><li><strong>Output</strong></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>************  Strategy Starts ***********
*****************************************
[Position] The position of HK.00700 is 0
[Signal] Long signal. Open long positions.
[OrderStatus] SUBMITTING {'Code': 'HK.00700', 'Price': 597.5, 'TradeSide': 'BUY', 'Quantity': 100.0}
[OrderStatus] SUBMITTED {'Code': 'HK.00700', 'Price': 597.5, 'TradeSide': 'BUY', 'Quantity': 100.0}
[OrderStatus] FILLED_ALL {'Code': 'HK.00700', 'Price': 597.5, 'TradeSide': 'BUY', 'Quantity': 100.0}
*****************************************
[Position] The position of HK.00700 is 100.0
[Signal] Short signal. Close positions.
[OrderStatus] SUBMITTING {'Code': 'HK.00700', 'Price': 596.5, 'TradeSide': 'SELL', 'Quantity': 100.0}
[OrderStatus] SUBMITTED {'Code': 'HK.00700', 'Price': 596.5, 'TradeSide': 'SELL', 'Quantity': 100.0}
[OrderStatus] FILLED_ALL {'Code': 'HK.00700', 'Price': 596.5, 'TradeSide': 'SELL', 'Quantity': 100.0}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div></div></div><div class="tab-content" style="display:;"><div class="ft-switcher"><div class="tab-header" style="display:none;"><ul><li class="active"> Python
            </li><li> Proto
            </li><li> C#
            </li><li> Java
            </li><li> C++
            </li><li> JavaScript
            </li></ul></div> <div class="tab-content" style="display:;"><div class="custom-block tip"><p class="custom-block-title">Tips</p> <ul><li>The content of this trading strategy is not an investment advice. It is for learning purposes only.</li></ul></div> <h2 id="7486-2"><a href="#7486-2" class="header-anchor">#</a> Strategy Introduction</h2> <p>Contruct a Double Moving Averaging Strategy.</p> <p>That is, using the 1 minute candlestick of an underlying stock, to calculate two moving averages of different periods, MA1 and MA3. The values of MA1 and MA3 are tracked to determine the timing of buying and selling.</p> <p>When MA1 &gt;= MA3, the underlying stock is judged to be strong and the market is considered to be a bull market, which shows a long signal.<br>
When MA1 &lt; MA3, the underlying stock is judged to be weak and the market is considered to be a bear market, which shows a short signal.</p> <h2 id="8601-2"><a href="#8601-2" class="header-anchor">#</a> Flow Chart</h2> <p><img src="/moomoo-api-doc/assets/img/strategy-flow-chart.9e0fbe4d.png" alt="strategy-flow-chart"></p> <h2 id="6526-2"><a href="#6526-2" class="header-anchor">#</a> Code Sample</h2> <ul><li><strong>Example</strong></li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> moomoo <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment">############################ Global Variables ############################</span>
MOOMOOOPEND_ADDRESS <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span>  <span class="token comment"># mooomoo OpenD listening address</span>
MOOMOOOPEND_PORT <span class="token operator">=</span> <span class="token number">11111</span>  <span class="token comment"># mooomoo OpenD listening port</span>

TRADING_ENVIRONMENT <span class="token operator">=</span> TrdEnv<span class="token punctuation">.</span>SIMULATE  <span class="token comment"># Trading environment: REAL / SIMULATE</span>
TRADING_MARKET <span class="token operator">=</span> TrdMarket<span class="token punctuation">.</span>HK  <span class="token comment"># Transaction market authority, used to filter accounts</span>
TRADING_PWD <span class="token operator">=</span> <span class="token string">'123456'</span>  <span class="token comment"># Trading password, used to unlock trading for real trading environment</span>
TRADING_PERIOD <span class="token operator">=</span> KLType<span class="token punctuation">.</span>K_1M  <span class="token comment"># Underlying trading time period</span>
TRADING_SECURITY <span class="token operator">=</span> <span class="token string">'HK.00700'</span>  <span class="token comment"># Underlying trading security code</span>
FAST_MOVING_AVERAGE <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># Parameter for fast moving average</span>
SLOW_MOVING_AVERAGE <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># Parameter for slow moving average</span>

quote_context <span class="token operator">=</span> OpenQuoteContext<span class="token punctuation">(</span>host<span class="token operator">=</span>MOOMOOOPEND_ADDRESS<span class="token punctuation">,</span> port<span class="token operator">=</span>MOOMOOOPEND_PORT<span class="token punctuation">)</span>  <span class="token comment"># Quotation context</span>
trade_context <span class="token operator">=</span> OpenSecTradeContext<span class="token punctuation">(</span>filter_trdmarket<span class="token operator">=</span>TRADING_MARKET<span class="token punctuation">,</span> host<span class="token operator">=</span>MOOMOOOPEND_ADDRESS<span class="token punctuation">,</span> port<span class="token operator">=</span>MOOMOOOPEND_PORT<span class="token punctuation">,</span> security_firm<span class="token operator">=</span>SecurityFirm<span class="token punctuation">.</span>FUTUSECURITIES<span class="token punctuation">)</span>  <span class="token comment"># Trading context. It must be consistent with the underlying varieties.</span>


<span class="token comment"># Unlock trade</span>
<span class="token keyword">def</span> <span class="token function">unlock_trade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> TRADING_ENVIRONMENT <span class="token operator">==</span> TrdEnv<span class="token punctuation">.</span>REAL<span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>unlock_trade<span class="token punctuation">(</span>TRADING_PWD<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Unlock trade failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Unlock Trade success!'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment"># Check if it is regular trading time for underlying security</span>
<span class="token keyword">def</span> <span class="token function">is_normal_trading_time</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_market_state<span class="token punctuation">(</span><span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get market state failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    market_state <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'market_state'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token triple-quoted-string string">'''
    MarketState.MORNING            HK and A-share morning
    MarketState.AFTERNOON          HK and A-share afternoon, US opening hours
    MarketState.FUTURE_DAY_OPEN    HK, SG, JP futures day market open
    MarketState.FUTURE_OPEN        US futures open
    MarketState.FUTURE_BREAK_OVER  Trading hours of U.S. futures after break
    MarketState.NIGHT_OPEN         HK, SG, JP futures night market open
    '''</span>
    <span class="token keyword">if</span> market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>MORNING <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>AFTERNOON <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>FUTURE_DAY_OPEN  <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>FUTURE_OPEN  <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>FUTURE_BREAK_OVER  <span class="token keyword">or</span> \
                    market_state <span class="token operator">==</span> MarketState<span class="token punctuation">.</span>NIGHT_OPEN<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'It is not regular trading hours.'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token comment"># Get positions</span>
<span class="token keyword">def</span> <span class="token function">get_holding_position</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    holding_position <span class="token operator">=</span> <span class="token number">0</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>position_list_query<span class="token punctuation">(</span>code<span class="token operator">=</span>code<span class="token punctuation">,</span> trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get holding position failed：'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> qty <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'qty'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            holding_position <span class="token operator">+=</span> qty
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Holding Position Status] The holding position quantity of {} is：{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> holding_position<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> holding_position



<span class="token comment"># Query for candlesticks, calculate moving average value and judge bull or bear</span>
<span class="token keyword">def</span> <span class="token function">calculate_bull_bear</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> fast_param<span class="token punctuation">,</span> slow_param<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fast_param <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">or</span> slow_param <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">if</span> fast_param <span class="token operator">&gt;</span> slow_param<span class="token punctuation">:</span>
        <span class="token keyword">return</span> calculate_bull_bear<span class="token punctuation">(</span>code<span class="token punctuation">,</span> slow_param<span class="token punctuation">,</span> fast_param<span class="token punctuation">)</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_cur_kline<span class="token punctuation">(</span>code<span class="token operator">=</span>code<span class="token punctuation">,</span> num<span class="token operator">=</span>slow_param <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> ktype<span class="token operator">=</span>TRADING_PERIOD<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get candlestick value failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    candlestick_list <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    fast_value <span class="token operator">=</span> <span class="token boolean">None</span>
    slow_value <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">)</span> <span class="token operator">&gt;</span> fast_param<span class="token punctuation">:</span>
        fast_value <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span> fast_param <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> fast_param
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">)</span> <span class="token operator">&gt;</span> slow_param<span class="token punctuation">:</span>
        slow_value <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>candlestick_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span> slow_param <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> slow_param
    <span class="token keyword">if</span> fast_value <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> slow_value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token keyword">if</span> fast_value <span class="token operator">&gt;=</span> slow_value <span class="token keyword">else</span> <span class="token operator">-</span><span class="token number">1</span>


<span class="token comment"># Get ask1 and bid1 from order book</span>
<span class="token keyword">def</span> <span class="token function">get_ask_and_bid</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_order_book<span class="token punctuation">(</span>code<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get order book failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token string">'Ask'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Bid'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>


<span class="token comment"># Open long positions</span>
<span class="token keyword">def</span> <span class="token function">open_position</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Get order book data</span>
    ask<span class="token punctuation">,</span> bid <span class="token operator">=</span> get_ask_and_bid<span class="token punctuation">(</span>code<span class="token punctuation">)</span>

    <span class="token comment"># Get quantity</span>
    open_quantity <span class="token operator">=</span> calculate_quantity<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Check whether buying power is enough</span>
    <span class="token keyword">if</span> is_valid_quantity<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> open_quantity<span class="token punctuation">,</span> ask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Place order</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>place_order<span class="token punctuation">(</span>price<span class="token operator">=</span>ask<span class="token punctuation">,</span> qty<span class="token operator">=</span>open_quantity<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">,</span> trd_side<span class="token operator">=</span>TrdSide<span class="token punctuation">.</span>BUY<span class="token punctuation">,</span>
                                              order_type<span class="token operator">=</span>OrderType<span class="token punctuation">.</span>NORMAL<span class="token punctuation">,</span> trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">,</span>
                                              remark<span class="token operator">=</span><span class="token string">'moving_average_strategy'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Open position failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Maximum quantity that can be bought less than transaction quantity.'</span><span class="token punctuation">)</span>


<span class="token comment"># Close position</span>
<span class="token keyword">def</span> <span class="token function">close_position</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> quantity<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Get order book data</span>
    ask<span class="token punctuation">,</span> bid <span class="token operator">=</span> get_ask_and_bid<span class="token punctuation">(</span>code<span class="token punctuation">)</span>

    <span class="token comment"># Check quantity</span>
    <span class="token keyword">if</span> quantity <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Invalid order quantity.'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token comment"># Close position</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>place_order<span class="token punctuation">(</span>price<span class="token operator">=</span>bid<span class="token punctuation">,</span> qty<span class="token operator">=</span>quantity<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">,</span> trd_side<span class="token operator">=</span>TrdSide<span class="token punctuation">.</span>SELL<span class="token punctuation">,</span>
                   order_type<span class="token operator">=</span>OrderType<span class="token punctuation">.</span>NORMAL<span class="token punctuation">,</span> trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">,</span> remark<span class="token operator">=</span><span class="token string">'moving_average_strategy'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Close position failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment"># Calculate order quantity</span>
<span class="token keyword">def</span> <span class="token function">calculate_quantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    price_quantity <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># Use minimum lot size</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> quote_context<span class="token punctuation">.</span>get_market_snapshot<span class="token punctuation">(</span><span class="token punctuation">[</span>TRADING_SECURITY<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get market snapshot failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> price_quantity
    price_quantity <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'lot_size'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> price_quantity


<span class="token comment"># Check the buying power is enough for the quantity</span>
<span class="token keyword">def</span> <span class="token function">is_valid_quantity</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> quantity<span class="token punctuation">,</span> price<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret<span class="token punctuation">,</span> data <span class="token operator">=</span> trade_context<span class="token punctuation">.</span>acctradinginfo_query<span class="token punctuation">(</span>order_type<span class="token operator">=</span>OrderType<span class="token punctuation">.</span>NORMAL<span class="token punctuation">,</span> code<span class="token operator">=</span>code<span class="token punctuation">,</span> price<span class="token operator">=</span>price<span class="token punctuation">,</span>
                                                   trd_env<span class="token operator">=</span>TRADING_ENVIRONMENT<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> RET_OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Get max long/short quantity failed: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    max_can_buy <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'max_cash_buy'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    max_can_sell <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'max_sell_short'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> quantity <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> quantity <span class="token operator">&lt;</span> max_can_buy
    <span class="token keyword">elif</span> quantity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_can_sell
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token comment"># Show order status</span>
<span class="token keyword">def</span> <span class="token function">show_order_status</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    order_status <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'order_status'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    order_info<span class="token punctuation">[</span><span class="token string">'Code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info<span class="token punctuation">[</span><span class="token string">'Price'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info<span class="token punctuation">[</span><span class="token string">'TradeSide'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'trd_side'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    order_info<span class="token punctuation">[</span><span class="token string">'Quantity'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'qty'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[OrderStatus]'</span><span class="token punctuation">,</span> order_status<span class="token punctuation">,</span> order_info<span class="token punctuation">)</span>


<span class="token comment">############################ Fill in the functions below to finish your trading strategy ############################</span>
<span class="token comment"># Strategy initialization. Run once when the strategy starts</span>
<span class="token keyword">def</span> <span class="token function">on_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># unlock trade (no need to unlock for paper trading)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> unlock_trade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'************  Strategy Starts ***********'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment"># Run once for each tick. You can write the main logic of the strategy here</span>
<span class="token keyword">def</span> <span class="token function">on_tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token comment"># Run once for each new candlestick. You can write the main logic of the strategy here</span>
<span class="token keyword">def</span> <span class="token function">on_bar_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Print seperate line</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*****************************************'</span><span class="token punctuation">)</span>

    <span class="token comment"># Only trade during regular trading hours</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_normal_trading_time<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    <span class="token comment"># Query for candlesticks, and calculate moving average value</span>
    bull_or_bear <span class="token operator">=</span> calculate_bull_bear<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> FAST_MOVING_AVERAGE<span class="token punctuation">,</span> SLOW_MOVING_AVERAGE<span class="token punctuation">)</span>

    <span class="token comment"># Get positions</span>
    holding_position <span class="token operator">=</span> get_holding_position<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">)</span>

    <span class="token comment"># Trading signals</span>
    <span class="token keyword">if</span> holding_position <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> bull_or_bear <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Long signal. Open long positions.'</span><span class="token punctuation">)</span>
            open_position<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Short signal. Do not open short positions.'</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> holding_position <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> bull_or_bear <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Short signal. Close positions.'</span><span class="token punctuation">)</span>
            close_position<span class="token punctuation">(</span>TRADING_SECURITY<span class="token punctuation">,</span> holding_position<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[Signal] Long signal. Do not add positions.'</span><span class="token punctuation">)</span>


<span class="token comment"># Run once when an order is filled</span>
<span class="token keyword">def</span> <span class="token function">on_fill</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token comment"># Run once when the status of an order changes</span>
<span class="token keyword">def</span> <span class="token function">on_order_status</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> TRADING_SECURITY<span class="token punctuation">:</span>
        show_order_status<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token comment">############################### Framework code, which can be ignored ###############################</span>
<span class="token keyword">class</span> <span class="token class-name">OnTickClass</span><span class="token punctuation">(</span>TickerHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        on_tick<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">OnBarClass</span><span class="token punctuation">(</span>CurKlineHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    last_time <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret_code<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>OnBarClass<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>on_recv_rsp<span class="token punctuation">(</span>rsp_pb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret_code <span class="token operator">==</span> RET_OK<span class="token punctuation">:</span>
            cur_time <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'time_key'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> cur_time <span class="token operator">!=</span> self<span class="token punctuation">.</span>last_time <span class="token keyword">and</span> data<span class="token punctuation">[</span><span class="token string">'k_type'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> TRADING_PERIOD<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>last_time <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    on_bar_open<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>last_time <span class="token operator">=</span> cur_time


<span class="token keyword">class</span> <span class="token class-name">OnOrderClass</span><span class="token punctuation">(</span>TradeOrderHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>OnOrderClass<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>on_recv_rsp<span class="token punctuation">(</span>rsp_pb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">==</span> RET_OK<span class="token punctuation">:</span>
            on_order_status<span class="token punctuation">(</span> data<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">OnFillClass</span><span class="token punctuation">(</span>TradeDealHandlerBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">on_recv_rsp</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rsp_pb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>OnFillClass<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>on_recv_rsp<span class="token punctuation">(</span>rsp_pb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret <span class="token operator">==</span> RET_OK<span class="token punctuation">:</span>
            on_fill<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token comment"># Main function</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># Strategy initialization</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> on_init<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Strategy initialization failed, exit script!'</span><span class="token punctuation">)</span>
        quote_context<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        trade_context<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Set up callback functions</span>
        quote_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnTickClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        quote_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnBarClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trade_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnOrderClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trade_context<span class="token punctuation">.</span>set_handler<span class="token punctuation">(</span>OnFillClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Subscribe tick-by-tick, candlestick and order book of the underlying trading security</span>
        quote_context<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span>code_list<span class="token operator">=</span><span class="token punctuation">[</span>TRADING_SECURITY<span class="token punctuation">]</span><span class="token punctuation">,</span> subtype_list<span class="token operator">=</span><span class="token punctuation">[</span>SubType<span class="token punctuation">.</span>TICKER<span class="token punctuation">,</span> SubType<span class="token punctuation">.</span>ORDER_BOOK<span class="token punctuation">,</span> TRADING_PERIOD<span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br></div></div><ul><li><strong>Output</strong></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>************  Strategy Starts ***********
*****************************************
[Position] The position of HK.00700 is 0
[Signal] Long signal. Open long positions.
[OrderStatus] SUBMITTING {'Code': 'HK.00700', 'Price': 597.5, 'TradeSide': 'BUY', 'Quantity': 100.0}
[OrderStatus] SUBMITTED {'Code': 'HK.00700', 'Price': 597.5, 'TradeSide': 'BUY', 'Quantity': 100.0}
[OrderStatus] FILLED_ALL {'Code': 'HK.00700', 'Price': 597.5, 'TradeSide': 'BUY', 'Quantity': 100.0}
*****************************************
[Position] The position of HK.00700 is 100.0
[Signal] Short signal. Close positions.
[OrderStatus] SUBMITTING {'Code': 'HK.00700', 'Price': 596.5, 'TradeSide': 'SELL', 'Quantity': 100.0}
[OrderStatus] SUBMITTED {'Code': 'HK.00700', 'Price': 596.5, 'TradeSide': 'SELL', 'Quantity': 100.0}
[OrderStatus] FILLED_ALL {'Code': 'HK.00700', 'Price': 596.5, 'TradeSide': 'SELL', 'Quantity': 100.0}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div><div class="tab-content" style="display:none;"></div></div></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/moomoo-api-doc/en/quick/demo.html" class="prev">
        Program Samples
      </a></span> <span class="next"><a href="/moomoo-api-doc/en/opend/opend-intro.html">
        Overview
      </a>
      →
    </span></p></div> </main> <aside class="rightbar"><ul class="rightbar-links"><a href="/moomoo-api-doc/en/quick/strategy-sample.html" aria-current="page" class="active rightbar-link">Strategy Setup</a></ul></aside></div><div class="global-ui"></div></div>
    <script src="/moomoo-api-doc/assets/js/app.76d125c0.js" defer></script><script src="/moomoo-api-doc/assets/js/2.e1858e4a.js" defer></script><script src="/moomoo-api-doc/assets/js/30.aee38619.js" defer></script><script src="/moomoo-api-doc/assets/js/28.3fe3716c.js" defer></script><script src="/moomoo-api-doc/assets/js/35.424be492.js" defer></script>
  </body>
</html>
